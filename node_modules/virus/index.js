var router  = require("router"),
	restify = require("restify"),
	clam    = require("clam-js");

var routes;

module.exports.init = function(opt) {
	
	var prefix = opt.prefix || '';

	routes = router();

	routes.post(prefix + '/scan', function(req, res, next) {
		var tmp = req.files.file.path;

		clam({port: 3310}, null, function() {
			this.scan(tmp, function(err, isClean) {
				if(err) {
					res.send(err);
					return;
				}

				res.send({
					"name": req.files.file.name,
					"isClean": isClean
				});
			});
		});
	});

	routes.post(prefix + "/steps/filter", function(req, res, next) {
		var type = req.files.file.type;
		if(type == "text/plain") {
			res.send({"filter": true});
		} else {
			res.send({"filter": false});
		}
	});

	// Error handling

	function error(req, res, next) {
		next(new restify.ResourceNotFoundError());
	}

	routes.get(error)
		  .head(error)
		  .post(error)
		  .put(error)
		  .del(error);
}

// -- Routing 
// -----------------------------------------------------
// Module enter point
// -----------------------------------------------------

module.exports.route = function(req, res, next) {
	routes(req, res, function(err) {
		if( ! next) {
			return;
		}

		if(err) { 
			next(err); 
		} else { 
			next(new restify.MethodNotAllowedError()); 
		}
	});                                                    
}

/* End of file */

